{
  "schema_version": "3.1.0",
  "schema_name": "Unified TO&E Schema (All Organizational Levels) - Ground Forces",
  "description": "Common schema for theater, corps, division, regiment, battalion, company, platoon, and squad levels. Every level includes full Strategic Command Summary (SCM) detail with supply/logistics and environmental factors for scenario generation.",
  "file_naming": "{nation}_{quarter}_{unit_designation}_toe.json",
  "stability": "HIGH - Standardized across all nations and organizational levels",
  
  "organization_levels": [
    "theater",
    "corps",
    "division",
    "regiment",
    "battalion",
    "company",
    "platoon",
    "squad"
  ],
  
  "required_fields": [
    "schema_type",
    "schema_version",
    "nation",
    "quarter",
    "unit_designation",
    "unit_type",
    "organization_level",
    "command",
    "total_personnel",
    "officers",
    "enlisted",
    "top_3_infantry_weapons",
    "ground_vehicles_total",
    "tanks",
    "artillery_total",
    "aircraft_total",
    "supply_logistics",
    "weather_environment",
    "subordinate_units",
    "validation"
  ],
  
  "field_specifications": {
    "schema_type": {
      "type": "string",
      "allowed_values": [
        "theater_scm",
        "corps_toe",
        "division_toe",
        "regiment_toe",
        "battalion_toe",
        "company_toe",
        "platoon_toe",
        "squad_toe"
      ],
      "description": "Type of organizational level"
    },
    
    "schema_version": {
      "type": "string",
      "format": "SEMVER",
      "example": "1.0.0",
      "description": "Schema version for compatibility tracking"
    },
    
    "nation": {
      "type": "string",
      "allowed_values": ["german", "italian", "british", "american", "french"],
      "description": "Nation identifier (lowercase)"
    },
    
    "quarter": {
      "type": "string",
      "format": "yyyyqn",
      "example": "1942q4",
      "description": "Quarter identifier (lowercase, no hyphen)"
    },
    
    "unit_designation": {
      "type": "string",
      "example": "XXI Corpo d'Armata",
      "description": "Official unit designation"
    },
    
    "unit_type": {
      "type": "string",
      "example": "Colonial Infantry Corps",
      "description": "Type of unit (functional description)"
    },
    
    "parent_formation": {
      "type": "string",
      "description": "Parent unit designation (null for theater level)"
    },
    
    "organization_level": {
      "type": "string",
      "allowed_values": ["theater", "corps", "division", "regiment", "battalion", "company", "platoon", "squad"],
      "description": "Organizational hierarchy level"
    },
    
    "command": {
      "type": "object",
      "required_fields": ["commander", "headquarters_location"],
      "structure": {
        "commander": {
          "name": "string (not 'Unknown' unless confidence < 50%)",
          "rank": "string",
          "appointment_date": "string (ISO date, optional)",
          "previous_service": "string (optional)"
        },
        "chief_of_staff": {
          "name": "string",
          "rank": "string",
          "note": "Corps/Division level only"
        },
        "headquarters_location": "string",
        "staff_strength": {
          "officers": "integer",
          "ncos": "integer (optional)",
          "enlisted": "integer"
        }
      }
    },
    
    "total_personnel": {
      "type": "integer",
      "minimum": 0,
      "description": "Total personnel in unit"
    },
    
    "officers": {
      "type": "integer",
      "minimum": 0,
      "description": "Officer count"
    },
    
    "ncos": {
      "type": "integer",
      "minimum": 0,
      "description": "NCO count (optional but recommended)"
    },
    
    "enlisted": {
      "type": "integer",
      "minimum": 0,
      "description": "Enlisted personnel count"
    },
    
    "top_3_infantry_weapons": {
      "type": "object",
      "description": "Top 3 infantry weapons with counts",
      "structure": {
        "1": {"weapon": "string", "count": "integer", "type": "string", "witw_id": "string (optional)"},
        "2": {"weapon": "string", "count": "integer", "type": "string", "witw_id": "string (optional)"},
        "3": {"weapon": "string", "count": "integer", "type": "string", "witw_id": "string (optional)"}
      }
    },
    
    "ground_vehicles_total": {
      "type": "integer",
      "minimum": 0,
      "description": "Total ground vehicles (sum of all categories)"
    },
    
    "tanks": {
      "type": "object",
      "required_subfields": ["total", "heavy_tanks", "medium_tanks", "light_tanks"],
      "structure": {
        "total": "integer",
        "operational": "integer (optional)",
        "heavy_tanks": {
          "total": "integer",
          "variants": {
            "{variant_name}": {
              "count": "integer",
              "operational": "integer",
              "witw_id": "string (optional)"
            }
          }
        },
        "medium_tanks": {"total": "integer", "variants": "object"},
        "light_tanks": {"total": "integer", "variants": "object"}
      },
      "validation_rule": "tanks.total MUST equal sum(heavy.total + medium.total + light.total)"
    },
    
    "halftracks": {
      "type": "object",
      "structure": {
        "total": "integer",
        "variants": {
          "{model_name}": {
            "count": "integer",
            "operational": "integer (optional)",
            "witw_id": "string (optional)",
            "role": "string (optional)"
          }
        }
      }
    },
    
    "armored_cars": {
      "type": "object",
      "structure": {"total": "integer", "variants": "object"}
    },
    
    "trucks": {
      "type": "object",
      "structure": {
        "total": "integer",
        "variants": {
          "{truck_model}": {
            "count": "integer",
            "capacity": "string (e.g., '3_ton', '15_cwt')",
            "witw_id": "string (optional)"
          }
        }
      }
    },
    
    "motorcycles": {
      "type": "object",
      "structure": {
        "total": "integer",
        "variants": {
          "{model_name}": {
            "count": "integer",
            "type": "string",
            "witw_id": "string (optional)"
          }
        }
      }
    },
    
    "support_vehicles": {
      "type": "object",
      "structure": {
        "total": "integer",
        "variants": {
          "{vehicle_type}": {
            "count": "integer",
            "type": "string",
            "witw_id": "string (optional)"
          }
        }
      }
    },
    
    "artillery_total": {
      "type": "integer",
      "minimum": 0,
      "description": "Total artillery pieces"
    },
    
    "field_artillery": {
      "type": "object",
      "structure": {
        "total": "integer",
        "variants": {
          "{gun_type}": {
            "count": "integer",
            "caliber": "string",
            "witw_id": "string (optional)"
          }
        }
      }
    },
    
    "anti_tank": {
      "type": "object",
      "description": "Anti-tank gun breakdown"
    },
    
    "anti_aircraft": {
      "type": "object",
      "description": "Anti-aircraft gun breakdown"
    },
    
    "aircraft_total": {
      "type": "integer",
      "minimum": 0,
      "description": "Total aircraft"
    },
    
    "fighters": {"type": "object", "description": "Fighter aircraft breakdown"},
    "bombers": {"type": "object", "description": "Bomber aircraft breakdown"},
    "reconnaissance": {"type": "object", "description": "Reconnaissance aircraft breakdown"},
    "transport": {"type": "object", "description": "Transport aircraft breakdown (optional)"},
    
    "supply_logistics": {
      "type": "object",
      "required": true,
      "version": "3.0",
      "description": "Supply and logistics state - CRITICAL for scenario generation",
      "structure": {
        "supply_status": {
          "type": "string",
          "description": "Qualitative assessment with operational context",
          "example": "Adequate for defensive operations, strained for offensive operations. Primary constraint: fuel delivery from Tripoli (1800km)."
        },
        "operational_radius_km": {
          "type": "integer",
          "minimum": 50,
          "maximum": 1000,
          "description": "Distance from main supply depot in kilometers",
          "example": 350
        },
        "fuel_reserves_days": {
          "type": "number",
          "minimum": 0,
          "maximum": 30,
          "description": "Days of fuel at current consumption rate",
          "example": 6.5
        },
        "ammunition_days": {
          "type": "number",
          "minimum": 0,
          "maximum": 30,
          "description": "Days of combat ammunition supply",
          "example": 8
        },
        "water_liters_per_day": {
          "type": "number",
          "minimum": 3,
          "maximum": 10,
          "description": "Water capacity per person per day (desert operations)",
          "example": 4.5
        }
      },
      "validation_rules": [
        "operational_radius_km must be realistic for terrain and logistics",
        "fuel_reserves_days typically 1-30 days",
        "ammunition_days typically 1-30 days",
        "water_liters_per_day typically 3-6 L/person/day for desert"
      ]
    },

    "weather_environment": {
      "type": "object",
      "required": true,
      "version": "3.0",
      "description": "Environmental conditions for the quarter - CRITICAL for scenario generation",
      "structure": {
        "season_quarter": {
          "type": "string",
          "format": "YYYY-QN with description",
          "example": "1941-Q2 (April-June)",
          "description": "Quarter and seasonal conditions"
        },
        "temperature_range_c": {
          "type": "object",
          "structure": {
            "min": "integer (-5 to 30 typical)",
            "max": "integer (20 to 50 typical)"
          },
          "validation": "min < max",
          "example": {"min": 18, "max": 35},
          "description": "Daily temperature range in Celsius"
        },
        "terrain_type": {
          "type": "string",
          "description": "Primary terrain type",
          "examples": ["coastal plain", "rocky desert", "sand desert", "mixed terrain"],
          "example": "coastal plain and rocky desert"
        },
        "storm_frequency_days": {
          "type": "integer",
          "minimum": 0,
          "maximum": 15,
          "description": "Sandstorms, Ghibli winds frequency (days per month)",
          "example": 2
        },
        "daylight_hours": {
          "type": "number",
          "minimum": 10,
          "maximum": 15,
          "description": "Average daylight hours (affects operational tempo)",
          "example": 13.5
        }
      },
      "validation_rules": [
        "temperature_min < temperature_max",
        "temperature values realistic for North Africa (-5 to 50°C range)",
        "storm_frequency realistic (0-10 days/month typical)",
        "daylight_hours realistic (10-15 hours for North Africa latitudes)"
      ]
    },
    
    "subordinate_units": {
      "type": "array",
      "description": "List of direct subordinate units",
      "item_schema": {
        "unit_designation": "string",
        "unit_type": "string",
        "commander": "string",
        "strength": "integer",
        "reference_file": "string (path to unit's JSON file)"
      }
    },
    
    "individual_positions": {
      "type": "array",
      "description": "SQUAD LEVEL ONLY - Individual soldier positions",
      "note": "Empty array for all levels except squad",
      "item_schema": {
        "position_number": "integer",
        "position": "string (e.g., 'Squad Leader', 'Rifleman')",
        "rank": "string",
        "name": "string (optional - for named characters)",
        "nationality": "string (optional)",
        "primary_weapon": {
          "weapon": "string",
          "witw_id": "string",
          "ammunition": "integer"
        },
        "secondary_weapon": "object (optional)",
        "equipment": "array of strings",
        "responsibilities": "string"
      }
    },
    
    "tactical_doctrine": {
      "type": "object",
      "description": "Tactical employment information",
      "structure": {
        "role": "string",
        "special_capabilities": "array of strings (optional)",
        "tactical_innovations": "array of strings (optional)",
        "known_issues": "array of strings (optional)",
        "desert_adaptations": "string (optional)"
      }
    },
    
    "wargaming_data": {
      "type": "object",
      "description": "Data for wargaming scenarios",
      "structure": {
        "scenario_suitability": "array of strings",
        "morale_rating": "integer (1-10)",
        "experience_level": "string (Green|Regular|Veteran|Elite)",
        "special_rules": "array of strings",
        "historical_engagements": "array of strings (optional)"
      }
    },
    
    "validation": {
      "type": "object",
      "required": true,
      "structure": {
        "source": "array of strings",
        "confidence": "integer (0-100)",
        "tier": "integer (1-4, NEW v3.1 - extraction quality tier)",
        "status": "string (production_ready|review_recommended|partial_needs_research|research_brief_created)",
        "last_updated": "string (ISO date)",
        "validated_by": "string (optional)",
        "known_gaps": "array of strings (deprecated in favor of gap_documentation)",
        "aggregation_status": "string (calculated|manually_entered|mixed)",
        "required_field_gaps": "array of strings (NEW v3.1 - list of required fields with gaps)",
        "gap_documentation": {
          "type": "object (NEW v3.1 - detailed gap information for Tier 2-3)",
          "structure": {
            "{field_name}": {
              "status": "unknown|estimated|partial",
              "reason": "string (why data unavailable)",
              "sources_checked": "array of strings (sources consulted)",
              "confidence_impact": "integer (negative impact on overall confidence)",
              "mitigation": "string (how to resolve gap, optional)",
              "estimate_method": "string (for estimated values, optional)"
            }
          }
        }
      }
    },

    "discovered_units": {
      "type": "array",
      "required": false,
      "description": "OPTIONAL: Units discovered during research that were NOT in the seed file. Agents report these for manual review and potential addition to work queue.",
      "structure": {
        "designation": "string (unit name/designation)",
        "nation": "string (nation identifier)",
        "quarter": "string (quarter identifier, format: yyyyqn) OR quarters: array of strings",
        "type": "string (unit type: division, corps, brigade, etc.)",
        "source": "string (where unit was discovered)",
        "confidence": "integer (0-100, confidence that unit exists)",
        "reason": "string (why this unit was discovered - parent/sibling/additional quarter/etc.)"
      },
      "example": [
        {
          "designation": "XXI Corpo d'Armata",
          "nation": "italian",
          "quarters": ["1940q3", "1940q4", "1941q1"],
          "type": "corps",
          "source": "Tessin Vol 12, page 245",
          "confidence": 90,
          "reason": "Parent corps mentioned in Brescia Division document but not in seed file for these quarters"
        }
      ]
    }
  },

  "validation_rules": [
    "tanks.total = sum(heavy_tanks.total + medium_tanks.total + light_tanks.total)",
    "total_personnel ≈ officers + ncos + enlisted (allow ±5% variance for rounding)",
    "ground_vehicles_total ≥ sum(all vehicle categories)",
    "artillery_total ≥ sum(field_artillery + anti_tank + anti_aircraft)",
    "aircraft_total ≥ sum(fighters + bombers + reconnaissance + transport)",
    "All variant counts must be positive integers",
    "operational counts must be <= total counts",
    "supreme_commander must not be 'Unknown' unless (confidence < 50% AND tier >= 3) OR gap is documented in gap_documentation",
    "Parent-child relationships: sum of subordinate totals = parent total (±5%)",
    "individual_positions array populated ONLY for squad_toe schema_type",
    "supply_logistics object REQUIRED with all 5 fields (v3.0)",
    "weather_environment object REQUIRED with all 5 fields (v3.0)",
    "operational_radius_km must be > 0 and realistic (50-1000km typical)",
    "fuel_reserves_days and ammunition_days typically 1-30 days",
    "temperature_range_c.min < temperature_range_c.max",
    "NO Wikipedia sources allowed in validation.source array"
  ],
  
  "data_quality": {
    "required_confidence": "75% minimum for Tier 1 (production_ready)",
    "tier_thresholds": {
      "tier_1": "75-100% confidence - All required fields present - production_ready",
      "tier_2": "60-74% confidence - Minor gaps in optional fields OR well-documented required field gaps - review_recommended",
      "tier_3": "50-59% confidence - Missing some required fields, substantial data exists - partial_needs_research",
      "tier_4": "<50% confidence - Insufficient data for extraction - research_brief_created"
    },
    "sources": "Minimum 2 sources per critical fact",
    "validation": "Equipment counts cross-checked against historical records",
    "aggregation_check": "Bottom-up validation from squad to theater",
    "gap_handling": "Tier 2-3 extractions document gaps in gap_documentation object with mitigation strategies"
  },
  
  "notes": [
    "This schema is UNIFIED across all organizational levels",
    "Squad level is the only level with individual_positions populated",
    "All other levels have empty individual_positions array",
    "Equipment detail is maintained at ALL levels (not just theater)",
    "Subordinate units reference child JSON files for complete detail"
  ],

  "changelog": {
    "3.1.0": {
      "date": "2025-10-15",
      "changes": [
        "Added tiered extraction system (Tier 1-4) to handle incomplete data gracefully",
        "Added validation.tier field (1-4) to indicate extraction quality",
        "Added validation.status field (production_ready|review_recommended|partial_needs_research|research_brief_created)",
        "Added validation.required_field_gaps array to list missing required fields",
        "Added validation.gap_documentation object for detailed gap information",
        "Updated data_quality section with tier thresholds (Tier 1: 75%+, Tier 2: 60-74%, Tier 3: 50-59%, Tier 4: <50%)",
        "Updated supreme_commander validation rule to allow documented gaps in Tier 2-3",
        "Deprecated validation.known_gaps in favor of gap_documentation",
        "Purpose: Enable partial extraction with documented gaps instead of all-or-nothing approach"
      ],
      "breaking_changes": false,
      "migration": "Existing v3.0 units can be upgraded by adding tier=1, status='production_ready' to validation object"
    },
    "3.0.0": {
      "date": "2025-10-13",
      "changes": [
        "Added supply_logistics object (Section 6) - 5 required fields for scenario generation",
        "Added weather_environment object (Section 7) - 5 required fields for seasonal modeling",
        "Updated validation rules to enforce supply/logistics and environmental data",
        "Added Wikipedia source blocking to validation rules",
        "Renamed from 'Unified TO&E Schema' to 'Ground Forces' schema (Air Forces will be separate Phase 7)",
        "Required for: scenario generation, wargaming exports, campaign system"
      ],
      "breaking_changes": true,
      "migration": "All unit JSONs must add supply_logistics and weather_environment objects"
    },
    "1.0.0": {
      "date": "2025-10-09",
      "changes": ["Initial schema with Sections 1-5 (command, personnel, equipment, artillery, aircraft)"]
    }
  }
}
